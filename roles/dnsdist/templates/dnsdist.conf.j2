-- Open ACL to the Internet
setACL("::/0")
addACL("0.0.0.0/0")

-- accept DNS queries on UDP and TCP
setLocal('127.0.0.1:53')

-- DNS over TLS
addTLSLocal('{{ STATIC }}', '/etc/dnsdist/fullchain.cer', '/etc/dnsdist/{{ DOMAIN }}.key', { reusePort=true } )

-- DNS over TLS, noads
addTLSLocal('{{ STATIC }}:854', '/etc/dnsdist/fullchain.cer', '/etc/dnsdist/{{ DOMAIN }}.key', { reusePort=true } )

-- DNS over HTTPS
addDOHLocal("127.0.0.1:8053", nil, nil, "/dns-query", { reusePort=true })
addDOHLocal("127.0.0.1:8054", nil, nil, "/ads", { reusePort=true })

-- Filter DNS queries to backend DNS based on endpoint
newServer({address="127.0.0.1:5454", pool="ads"})
addAction(HTTPPathRegexRule("ads"), PoolAction("ads"))

-- DoT noads
addAction(DSTPortRule(854), PoolAction("ads"))

-- fwd queries to:
newServer({address="127.0.0.1:5353"})
